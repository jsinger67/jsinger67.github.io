<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Operator Precedence - The Parol Parser Generator</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Parol Parser Generator</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="operator-precedence"><a class="header" href="#operator-precedence">Operator Precedence</a></h1>
<p>Operator precedence is implemented through grammar definitions. By placing higher-priority elements
into sub-categories, you force the parser to branch into those first, resulting in earlier
evaluation.</p>
<p>Consider the following example:</p>
<pre><code class="language-parol">%start Precedence
%title "Operator precedence"
%comment "Shows the handling of operator precedence in `parol`"

%%

// ---------------------------------------------------------
// VARIABLE
Variable: /(?i)[A-Z][0-9A-Z]*/ ;
Literal : /[0-9]+/ ;

// ---------------------------------------------------------
// OPERATOR SYMBOLS
Plus    : '+' ;
Minus   : '-' ;
MulOp   : "\*|/" ;

// ---------------------------------------------------------
// PARENTHESIS
LParen  : '(' ;
RParen  : ')' ;

// ---------------------------------------------------------
// EXPRESSIONS in order of increasing precedence
Precedence      : Summation ;
Summation       : Multiplication { (Plus | Minus) Multiplication } ;
Multiplication  : Factor { MulOp Factor } ;
Factor          : Literal
                | Variable
                | Minus Factor
                | LParen Precedence RParen ;
</code></pre>
<p>Parsing the string <code>-1 + x * 5</code> with the generated parser produces the following parse tree:</p>
<p><img src="./precedence/test.svg" alt="Parse Tree" /></p>
<p>Notice that the innermost operator is evaluated first by the parser—here, the negation in the
<code>Factor</code> production.</p>
<p><code>Multiplication</code> is the second-highest priority in this example, as it is a sub-category of
<code>Summation</code>.</p>
<p>To try this grammar, run:</p>
<pre><code class="language-shell">parol new --bin --path .\precedence --tree
</code></pre>
<p>Replace the generated dummy grammar with the example above. Also, set <code>test.txt</code> to:</p>
<pre><code class="language-text">-1 + x * 5
</code></pre>
<p>Parse the text by running:</p>
<pre><code class="language-shell">cargo run ./test.txt
</code></pre>
<p>from the root of the generated crate.</p>
<p>Because the <code>--tree</code> flag was used with <code>parol new</code>, parse trees are generated automatically. Look
for a <code>test.svg</code> file next to <code>test.txt</code>.</p>
<p>It is recommended to use parse tree generation during grammar development and remove it when
deploying your parser in production.</p>
<p><em><strong>However, the parse tree can be useful in certain scenarios. Because it's lossless, it also
includes otherwise discarded tokens like spaces.</strong></em></p>
<h2 id="how-do-i-implement-the-grammar-processing"><a class="header" href="#how-do-i-implement-the-grammar-processing">How do I implement the grammar processing?</a></h2>
<p>You should have a look at the example <a href="https://github.com/jsinger67/parol/tree/main/examples/calc">calc</a>.</p>
<p>Basically, the grammar processing is implemented in the <code>calc_grammar.rs</code>.</p>
<p>The struct <code>CalcGrammar</code> contains a collection of variables and their values called <code>env</code>.
It also contains a stack of values that holds the intermediate results during the calculation:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub calc_results: Vec&lt;DefinitionRange&gt;,
pub env: BTreeMap&lt;String, DefinitionRange&gt;,
<span class="boring">}</span></code></pre></pre>
<p>You can extend the struct <code>PrecedenceGrammar</code> in <code>src\precedence_grammar.rs</code> the same way.</p>
<p>Now you can implement selected semantic actions from the <code>PrecedenceGrammarTrait</code>. Look at the
generated <code>src\precedence_grammar_trait.rs</code>. It contains all available semantic actions which are
bound to non-terminals.</p>
<p>To implement for instance the <code>variable</code> action, copy the <code>fn variable...</code> block into the</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;'t&gt; PrecedenceGrammarTrait&lt;'t&gt; for PrecedenceGrammar&lt;'t&gt; {

}
<span class="boring">}</span></code></pre></pre>
<p>This way:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;'t&gt; PrecedenceGrammarTrait&lt;'t&gt; for PrecedenceGrammar&lt;'t&gt; {
    /// Semantic action for non-terminal 'Variable'
    fn variable(&amp;mut self, _arg: &amp;Variable&lt;'t&gt;) -&gt; Result&lt;()&gt; {
        Ok(())
    }

    /// Semantic action for non-terminal 'Precedence'
    fn precedence(&amp;mut self, arg: &amp;Precedence&lt;'t&gt;) -&gt; Result&lt;()&gt; {
        self.precedence = Some(arg.clone());
        Ok(())
    }
}
<span class="boring">}</span></code></pre></pre>
<p>Now you can handle any variable. Because our grammar has no assignment yet, the function is simple.
It tries to retrieve the variables value from the <code>env</code>. If the variable is not found in the <code>env</code>
it creates a new entry with default value 0. Then it pushes this value on the <code>calc_results</code> vector
for later processing:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    /// Semantic action for non-terminal 'Variable'
    fn variable(&amp;mut self, var: &amp;Variable&lt;'t&gt;) -&gt; Result&lt;()&gt; {
        // Try to find the variable in the environment
        let value = if let Some(value) = self.env.get(var.variable.text()) {
            *value
        } else {
            // Insert default value for unassigned variable
            self.env
                .insert(var.variable.text().to_string(), DefinitionRange::default());
            DefinitionRange::default()
        };
        self.calc_results.push(value);
        Ok(())
    }
<span class="boring">}</span></code></pre></pre>
<p>Don't forget to <code>use</code> the type <code>Variable</code> from the module <code>precedence_grammar_trait</code>.</p>
<p>To see the results modify the Display implementation of <code>PrecedenceGrammar</code> to show the intermediate
results and the environment.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Display for PrecedenceGrammar&lt;'_&gt; {
    fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; std::result::Result&lt;(), Error&gt; {
        writeln!(
            f,
            "Result stack\n{}",
            self.calc_results
                .iter()
                .rev()
                .map(|e| format!("{}", e))
                .collect::&lt;Vec&lt;String&gt;&gt;()
                .join("\n")
        )?;
        writeln!(
            f,
            "\nEnv\n{}",
            self.env
                .iter()
                .map(|(i, v)| format!("{} = {}", i, v))
                .collect::&lt;Vec&lt;String&gt;&gt;()
                .join("\n")
        )
    }
}
<span class="boring">}</span></code></pre></pre>
<pre><code class="language-shell">    cargo run ./test.txt
Parsing took 0 milliseconds.
Success!
Result stack
0

Env
x = 0
</code></pre>
<p>As expected the variable <code>x</code> has been inserted into the environment with default value 0.
The Value 0 is still on the stack.</p>
<p>Now the next step could be to implement the semantic action for non-terminal <code>Literal</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    /// Semantic action for non-terminal 'Literal'
    fn literal(&amp;mut self, lit: &amp;Literal&lt;'t&gt;) -&gt; Result&lt;()&gt; {
        // Convert the integer literal to its value
        let lit = lit
            .literal
            .text()
            .parse::&lt;DefinitionRange&gt;()
            .map_err(|e| parol!(format!("Cannot convert literal to integer: {}", e)))?;
        // Push it onto the calculation stack
        self.calc_results.push(lit);
        Ok(())
    }
<span class="boring">}</span></code></pre></pre>
<pre><code class="language-shell">    cargo run ./test.txt
Parsing took 0 milliseconds.
Success!
Result stack
5
0
1

Env
x = 0
</code></pre>
<p>Now I think you could continue on your own. Implement the unary and binary operations by taking one
or two top most numbers from the calculation stack and push the result on the stack again.
If all is implemented correctly the end result of the calculation should be laying as single value
on top of the calculation stack.</p>
<p><code>-1 + x * 5</code> should the result into <code>-1 + 0 * 5</code> =&gt; <code>-1</code>.</p>
<p>Now you could add assignments to your Grammar to be able to use variables to store and access values.
Allow the grammar to contain multiple operations and remove assigned values from the calculation
stack.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ParGrammar.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="OperatorAssociativity.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ParGrammar.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="OperatorAssociativity.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
