<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Changes in version 2 - The Parol Parser Generator</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="Introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="History.html"><strong aria-hidden="true">2.</strong> History</a></li><li class="chapter-item expanded "><a href="GettingStarted.html"><strong aria-hidden="true">3.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="ParGrammar.html"><strong aria-hidden="true">4.</strong> Grammar description syntax</a></li><li class="chapter-item expanded "><a href="OperatorPrecedence.html"><strong aria-hidden="true">5.</strong> Operator precedence</a></li><li class="chapter-item expanded "><a href="OperatorAssociativity.html"><strong aria-hidden="true">6.</strong> Operator associativity</a></li><li class="chapter-item expanded "><a href="AstGeneration.html"><strong aria-hidden="true">7.</strong> AST generation</a></li><li class="chapter-item expanded "><a href="VanillaMode.html"><strong aria-hidden="true">8.</strong> Vanilla mode</a></li><li class="chapter-item expanded "><a href="SemanticActions.html"><strong aria-hidden="true">9.</strong> Semantic actions</a></li><li class="chapter-item expanded "><a href="ParolVersion2.html" class="active"><strong aria-hidden="true">10.</strong> Changes in version 2</a></li><li class="chapter-item expanded "><a href="UsefulTips.html"><strong aria-hidden="true">11.</strong> Useful tips</a></li><li class="chapter-item expanded "><a href="QnA.html"><strong aria-hidden="true">12.</strong> Q&A</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Parol Parser Generator</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="changes-in-version-2"><a class="header" href="#changes-in-version-2">Changes in version 2</a></h1>
<h2 id="new-scannerlexer-crate"><a class="header" href="#new-scannerlexer-crate">New scanner/lexer crate</a></h2>
<p>As of version 2.0 <code>parol</code> uses the brand new and self written scanner crate
<a href="https://github.com/jsinger67/scnr">scrn</a>.</p>
<h3 id="motivation"><a class="header" href="#motivation">Motivation</a></h3>
<p>The motivation for switching from <code>regex-automata</code> to <code>scnr</code> was the performance of the creation of
tokenizers out of regexes during the startup of generated parsers. For small input texts this share
of the parser runtime exceeded the share of actual parsing times by a factor of &gt;30. This meant that
for the advantage of fast parsing you had to sacrifice a lot of costs for building this efficient
scanner.</p>
<p>This doesn't mean that <code>regex-automata</code> is in any way bad, on the contrary, it is a very versatile
and valuable crate for a multitude of uses cases. It only means that the use in a lexical scanner,
where you don't need the majority of features like named and unnamed capture groups is not the
optimal decision.</p>
<p>Also <code>scnr</code> is not perfect and can't compete with <code>regex-automata</code> regarding the supported regex
features. But being able and willing to forgo some comfort opens up the opportunity to gain a lot of
speed in the phase of tokenizer creation and even during the actual scanning.</p>
<p>I can give some figures to support the claims made:</p>
<p>First for the speed of building the scanner resp. the tokenizer:</p>
<div class="table-wrapper"><table><thead><tr><th>118 terminals</th><th style="text-align: right">Version 1</th><th style="text-align: right">Version 2</th></tr></thead><tbody>
<tr><td>build scanner</td><td style="text-align: right">33ms</td><td style="text-align: right">1ms</td></tr>
</tbody></table>
</div>
<p>In both cases the same conditions are applied. The regex comprised 118 terminals.</p>
<p>Then some measurements of parsing speed.</p>
<div class="table-wrapper"><table><thead><tr><th>Input (Bytes, Tokens)</th><th style="text-align: right">Version 1</th><th style="text-align: right">Version 2</th></tr></thead><tbody>
<tr><td>549, 175</td><td style="text-align: right">0.01ms + 33ms</td><td style="text-align: right">1.2ms + 1ms</td></tr>
<tr><td>58525, 3111</td><td style="text-align: right">0.76ms + 33ms</td><td style="text-align: right">2.34ms + 1 ms</td></tr>
<tr><td>5873100, 1159200</td><td style="text-align: right">122ms + 33ms</td><td style="text-align: right">80ms + 1ms</td></tr>
</tbody></table>
</div>
<p>The added value in cells with times is the constant time to create the tokenizer, which is required
once for each call to the generated parser.</p>
<p>As you can see, <code>scnr</code> does its job well.</p>
<h3 id="impact-on-lexical-analysis"><a class="header" href="#impact-on-lexical-analysis">Impact on lexical analysis</a></h3>
<p>Since <code>scnr</code> doesn't support some regex feature which are either complicated, costly or unnecessary,
some things can't be resolved simply by the means regex crates like <code>regex-automata</code> provide.
One major feature worth mentioning is non-greediness. Lets dive in this topic with the help of an
example.</p>
<p>Let's use the commonly known block comment as our example.</p>
<p>In version 1 you would have simply used a non-greedy repetition to skip over all characters in
between the start of the comment and the end of the comment.</p>
<pre><code class="language-regex">/\*[.\r\n]*?\*/
</code></pre>
<p>or even using s flag, which allows <code>.</code> to match <code>\n</code> too:</p>
<pre><code class="language-regex">/\*(?s).*?\*/
</code></pre>
<p>In version 2 with <code>scnr</code> you can not use either of these two versions. <code>scnr</code> does not support
non-greediness and does also not support flags currently. In this regard it is in good company with
other lexer/scanner generators like Lex.</p>
<p>You can although simulate non-greediness by carefully creating your regex or by introducing new
dedicated scanner modes. Both variants are explained now.</p>
<h4 id="special-regex-design"><a class="header" href="#special-regex-design">Special regex design</a></h4>
<p>You can consider the following solution</p>
<pre><code class="language-regex">/\*([^*]|\*[^/])*\*/
</code></pre>
<p>In this working example you explicitly restrict the portion that has to be repeated non-greedily by
suppressing the acceptance of the following regex (the end of comment part) within the repetition.</p>
<p>The above solution can be phrased like this:
&gt;Match all characters except <code>*</code> OR a <code>*</code> NOT followed by the character <code>/</code>, where <code>*</code> is the start
of the end comment part and <code>/</code> is the next character after the start of the end comment part.</p>
<p>I know that this is cumbersome and maybe sometimes not even feasible when the following part is too
complex. Therefore there exist a second approach to cope with missing non-greediness.</p>
<h4 id="scanner-modes"><a class="header" href="#scanner-modes">Scanner modes</a></h4>
<p>You can make the repetition also non-greedy by creating a second scanner mode, here named <code>COMMENT</code>.</p>
<p>This mode is entered on the <strong>comment start</strong> <code>/\*</code>, then handles all tokens inside a comment and
enters <code>INITIAL</code> mode on the <strong>comment end</strong> <code>\*/</code> again.</p>
<pre><code class="language-parol">
%start NgBlockComment
%comment &quot;Non-greedy block comment&quot;

%on CommentStart %enter COMMENT

%scanner COMMENT {
    %auto_newline_off
    %auto_ws_off
    %on CommentEnd %enter INITIAL
}

%%

NgBlockComment: Comments;
Comments: { Comment };
Comment: CommentStart { CommentContent } CommentEnd;
CommentStart: '/*';                 // This token is only valid in mode INITIAL
CommentEnd: &lt;COMMENT&gt;'*/';          // This token is only valid in mode COMMENT
CommentContent: &lt;COMMENT&gt;/[.\r\n]/; // This token is only valid in mode COMMENT
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="SemanticActions.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="UsefulTips.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="SemanticActions.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="UsefulTips.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
